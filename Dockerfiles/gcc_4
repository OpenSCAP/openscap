FROM gcc:4

ENV OSCAP_USERNAME oscap
ENV OSCAP_DIR openscap
ENV BUILD_JOBS 4

RUN true \
	&& apt-get -qq update \
	&& apt-get -qq install cmake libdbus-1-dev libdbus-glib-1-dev libcurl4-openssl-dev libgcrypt20-dev libselinux1-dev libxslt1-dev libgconf2-dev libacl1-dev libblkid-dev libcap-dev libxml2-dev libldap2-dev libpcre3-dev python-dev swig libxml-parser-perl libxml-xpath-perl libperl-dev libbz2-dev librpm-dev \
	&& mkdir -p /home/$OSCAP_USERNAME \
	&& apt-get autoremove \
	&& apt-get clean \
	&& apt-get autoclean \
	&& rm -rf /usr/share/doc /usr/share/doc-base /usr/share/man /usr/share/locale /usr/share/zoneinfo \
	&& true

WORKDIR /home/$OSCAP_USERNAME

COPY . $OSCAP_DIR/

# clean the build dir in case the user is also building OpenSCAP locally
RUN rm -rf $OSCAP_DIR/build/*

WORKDIR /home/$OSCAP_USERNAME/$OSCAP_DIR/build

CMD true \
	&& cmake .. \
	&& make -j $BUILD_JOBS \
	&& ctest --output-on-failure -j $BUILD_JOBS -R API -E 'API/(OVAL|XCCDF)/unittests/all.sh' \
	&& true
